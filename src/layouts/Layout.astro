---
import Cart from '../components/Cart.astro';
import WhatsAppBtn from '../components/WhatsAppBtn.astro';
import { getCollection } from 'astro:content';
import CookieManager from '../components/CookieManager.astro';

import '@fontsource/inter/300.css';
import '@fontsource/inter/400.css';
import '@fontsource/inter/600.css';
import '@fontsource-variable/playfair-display';

interface Props {
	title: string;
	description?: string;
	image?: string;
    noindex?: boolean;
    schema?: string; 
}

const { 
    title, 
    description = "Siempre Divinas, tienda online de ropa, calzado y complementos para mujer. Moda diaria, buena calidad y precios asequibles. Compra online fácil y segura.", 
    image = "/img/logo.png", 
    noindex = false,
    schema
} = Astro.props;

const categories = (await getCollection('categorias'))
  .sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

const subcategories = (await getCollection('subcategorias'))
  .sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

// --- LÓGICA DE MENÚ ---
const categoriesWithSubcategories = categories.map(cat => {
    const children = subcategories.filter(sub => {
        const parentsRaw = sub.data.parentCategory;
        if (!parentsRaw) return false;
        const parentsList = Array.isArray(parentsRaw) ? parentsRaw : [parentsRaw];
        return parentsList.includes(cat.data.title) || parentsList.includes(cat.slug);
    });
    
    return {
        ...cat,
        subcategories: children
    };
});
// ---------------------------------

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const siteUrl = Astro.site ? Astro.site.toString() : 'https://siempredivinas.com/';
const logoUrl = new URL('/img/logo.png', siteUrl).toString();
---

<!doctype html>
<html lang="es" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
        <link rel="preload" as="image" href="/img/home-bg.webp" fetchpriority="high" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
        <meta name="google-site-verification" content="Ne7AjyMzT0K-bMD7iY1n0PhIb2M17QrJsA_k3-Hkswc" />
		<title>{title} | Siempre Divinas</title>
        <meta name="description" content={description} />
        <link rel="canonical" href={canonicalURL} />
        {noindex ? (<meta name="robots" content="noindex, nofollow" />) : (<meta name="robots" content="index, follow" />)}
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={new URL(image, siteUrl)} />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:type" content="website" />
        <meta property="og:site_name" content="Siempre Divinas" />
        <meta property="og:locale" content="es_ES" />
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org", "@type": "WebSite", "name": "Siempre Divinas", "url": siteUrl,
            "potentialAction": {"@type": "SearchAction", "target": `${siteUrl}?q={search_term_string}`, "query-input": "required name=search_term_string"}
        })} />
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org", "@type": "OnlineStore", "name": "Siempre Divinas", "image": logoUrl, "@id": siteUrl, "url": siteUrl, "telephone": "+34681883707", "email": "info@siempredivinas.com",
            "founder": {"@type": "Person", "name": "Ana María Diaz Labella"}
        })} />
        {schema && <script type="application/ld+json" set:html={schema} />}
	</head>
	
    <body class="bg-white text-gray-900 flex flex-col min-h-screen font-sans">
        
        <header class="bg-white shadow-md sticky top-0 z-40 font-sans relative !overflow-visible">
            
            <div class="hidden md:block">
                <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                    <div class="flex-1"></div>
                    <a href="/" class="flex-shrink-0 transform hover:scale-105 transition duration-500" aria-label="Ir a la página de inicio">
                        <img 
                            src="/img/logo.png" 
                            alt="Siempre Divinas" 
                            class="w-[200px] h-[100px] object-cover object-center drop-shadow-sm" 
                            width="200" 
                            height="100"
                        />
                    </a>
                    <div class="flex-1 flex justify-end items-center gap-6"> 
                        <a href="/contacto" class="hover:text-pink-600 transition relative group py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-800 group-hover:text-pink-600 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>
                        </a>
                        <button onclick="window.dispatchEvent(new Event('toggle-cart'))" class="relative group p-2 hover:bg-gray-100 rounded-full transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-800 group-hover:text-pink-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg><span class="cart-count-badge absolute -top-1 -right-1 bg-pink-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full hidden shadow-md border-2 border-white">0</span></button>
                    </div>
                </div>
                
                <nav class="bg-gray-100 py-2 border-t border-gray-200 relative z-[1000]">
                    <div class="container mx-auto px-4 flex justify-center gap-8 font-medium text-gray-700 uppercase tracking-wider text-sm">
                        {categoriesWithSubcategories.map((category) => (
                            <div class="relative group py-2">
                                <a href={`/categorias/${category.slug}`} class="hover:text-pink-600 transition relative py-2 block">
                                    {category.data.title}
                                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-pink-600 transition-all duration-300 group-hover:w-full"></span>
                                </a>
                                {category.subcategories.length > 0 && (
                                    <div class="absolute left-1/2 -translate-x-1/2 top-full mt-0 w-48 bg-white shadow-xl rounded-b-md overflow-hidden hidden group-hover:block z-[1001] border border-gray-100 animate-in fade-in slide-in-from-top-2 duration-200">
                                        {category.subcategories.map((subcat) => (
                                            <a href={`/subcategorias/${subcat.slug}`} class="block px-4 py-3 text-gray-800 hover:bg-pink-50 hover:text-pink-600 transition text-sm normal-case border-b border-gray-50 last:border-0">
                                                {subcat.data.title}
                                            </a>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </nav>
            </div>

            <div class="md:hidden container mx-auto px-4 py-2 flex items-center justify-between">
                <div class="flex-1 flex justify-start">
                    <button id="mobile-menu-btn" class="p-2 text-gray-700 hover:text-pink-600 focus:outline-none z-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                </div>
                
                <a href="/" class="flex-shrink-0 transform hover:scale-105 transition duration-500">
                    <img 
                        src="/img/logo.png" 
                        alt="Siempre Divinas" 
                        class="w-[200px] h-[100px] object-cover object-center drop-shadow-sm" 
                        width="200" 
                        height="100"
                    />
                </a>

                <div class="flex-1 flex justify-end items-center gap-6">
                    <button onclick="window.dispatchEvent(new Event('toggle-cart'))" class="relative group p-2 hover:bg-gray-100 rounded-full transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-800 group-hover:text-pink-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg><span class="cart-count-badge absolute -top-1 -right-1 bg-pink-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full hidden shadow-md border-2 border-white">0</span></button>
                </div>
            </div>

            <div id="mobile-side-menu" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden overflow-y-auto">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50">
                    <span class="font-bold text-lg text-gray-800">Menú</span>
                    <button id="close-mobile-menu-btn" class="p-2 text-gray-700 hover:text-pink-600 focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
                <nav class="flex flex-col p-4">
                    {categoriesWithSubcategories.map((category) => (
                        category.subcategories.length > 0 ? (
                            <details class="group">
                                <summary class="block px-4 py-3 text-gray-800 hover:bg-pink-50 hover:text-pink-600 border-b border-gray-100 font-medium transition cursor-pointer flex justify-between items-center list-none select-none">
                                    <span>{category.data.title}</span>
                                    <span class="transform transition-transform duration-300 group-open:rotate-180"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></span>
                                </summary>
                                <div class="pl-4 bg-gray-50 border-b border-gray-100 rounded-b-lg">
                                    <a href={`/categorias/${category.slug}`} class="block px-4 py-3 text-pink-600 font-bold hover:bg-pink-100 transition text-sm border-b border-gray-100 border-dashed">Ver todo {category.data.title} &rarr;</a>
                                    {category.subcategories.map((subcat) => (
                                        <a href={`/subcategorias/${subcat.slug}`} class="block px-4 py-3 text-gray-700 hover:bg-pink-100 hover:text-pink-700 transition text-sm">{subcat.data.title}</a>
                                    ))}
                                </div>
                            </details>
