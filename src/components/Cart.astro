---
---
<div id="cart-overlay" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity opacity-0 backdrop-blur-sm"></div>

<div id="cart-panel" class="fixed top-0 right-0 h-full w-full md:w-[480px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
  
  <div class="p-4 border-b flex justify-between items-center bg-gray-50">
    <h2 class="text-xl font-serif font-bold text-gray-800 flex items-center gap-2">
      <span>ğŸ›ï¸</span> Tu Cesta
    </h2>
    <button id="close-cart" aria-label="Cerrar carrito" class="text-gray-500 hover:text-red-500 transition p-2 bg-white rounded-full border border-gray-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white">
    <div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
        <p>Tu cesta estÃ¡ vacÃ­a</p>
    </div>
  </div>

  <div class="p-4 bg-gray-50 border-t border-gray-200 shadow-inner">
      <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
          <span>ğŸ“</span> Datos de EnvÃ­o (Obligatorio)
      </h3>
      <div class="space-y-3">
          <input type="text" id="cust-name" placeholder="Tu Nombre y Apellidos" class="w-full px-4 py-2 rounded border border-gray-300 focus:border-pink-500 focus:outline-none text-sm" />
          <input type="tel" id="cust-phone" placeholder="TelÃ©fono de contacto" class="w-full px-4 py-2 rounded border border-gray-300 focus:border-pink-500 focus:outline-none text-sm" />
          <input type="text" id="cust-address" placeholder="DirecciÃ³n, Ciudad y CÃ³digo Postal" class="w-full px-4 py-2 rounded border border-gray-300 focus:border-pink-500 focus:outline-none text-sm" />
      </div>
  </div>

  <div class="p-4 border-t bg-white">
    <div class="flex justify-between items-center mb-4">
      <span class="text-lg font-bold text-gray-700">Total a pagar:</span>
      <span id="cart-total" class="text-pink-600 text-2xl font-bold">0.00â‚¬</span>
    </div>
    
    <button id="checkout-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-md transition transform hover:scale-[1.01] flex items-center justify-center gap-2">
      <span class="text-xl">ğŸ“±</span> ENVIAR PEDIDO POR WHATSAPP
    </button>
  </div>
</div>

<script>
  // ELEMENTOS DEL DOM
  const cartOverlay = document.getElementById('cart-overlay');
  const cartPanel = document.getElementById('cart-panel');
  const closeBtn = document.getElementById('close-cart');
  const cartItemsContainer = document.getElementById('cart-items');
  const cartTotalElement = document.getElementById('cart-total');
  const checkoutBtn = document.getElementById('checkout-btn');

  // INPUTS DE CLIENTE
  const inputName = document.getElementById('cust-name');
  const inputPhone = document.getElementById('cust-phone');
  const inputAddress = document.getElementById('cust-address');

  // TELÃ‰FONO DE LA TIENDA
  const PHONE_NUMBER = "34681883707"; 

  // 1. ABRIR Y CERRAR CARRITO
  function openCart() {
    cartOverlay.classList.remove('hidden');
    setTimeout(() => {
        cartOverlay.classList.remove('opacity-0');
        cartPanel.classList.remove('translate-x-full');
    }, 10);
    renderCart(); 
  }

  function closeCart() {
    cartOverlay.classList.add('opacity-0');
    cartPanel.classList.add('translate-x-full');
    setTimeout(() => {
        cartOverlay.classList.add('hidden');
    }, 300);
  }

  window.addEventListener('toggle-cart', openCart);
  closeBtn.addEventListener('click', closeCart);
  cartOverlay.addEventListener('click', closeCart);

  // 2. RENDERIZAR
  function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cartItemsContainer.innerHTML = '';
    let total = 0;

    if (cart.length === 0) {
      cartItemsContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
            <span class="text-4xl mb-2">ğŸ›’</span>
            <p>Tu cesta estÃ¡ vacÃ­a</p>
            <button onclick="document.getElementById('close-cart').click()" class="mt-4 text-pink-600 font-bold hover:underline text-sm">Seguir comprando</button>
        </div>
      `;
      cartTotalElement.innerText = '0.00â‚¬';
      // Desactivar botÃ³n si estÃ¡ vacÃ­o
      checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
      return;
    }
    
    checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');

    cart.forEach((item) => {
      total += item.price * item.quantity;
      
      const itemHTML = `
        <div class="flex gap-3 bg-white p-3 rounded border border-gray-100 relative group hover:border-pink-200 transition">
            <img src="${item.image}" class="w-16 h-20 object-cover rounded" />
            
            <div class="flex-1 pr-6">
                <h3 class="font-bold text-gray-800 text-sm line-clamp-2">${item.title}</h3>
                <p class="text-xs text-gray-500 mt-1">Talla: <span class="font-bold text-gray-700">${item.size}</span> | Color: ${item.color}</p>
                
                <div class="flex justify-between items-end mt-2">
                    <p class="text-pink-600 font-bold text-sm">${item.price}â‚¬</p>
                    
                    <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded px-1">
                        <button class="text-gray-500 hover:text-black font-bold px-2" onclick="updateQuantity('${item.id}', -1)">âˆ’</button>
                        <span class="text-xs font-bold w-3 text-center">${item.quantity}</span>
                        <button class="text-gray-500 hover:text-black font-bold px-2" onclick="updateQuantity('${item.id}', 1)">+</button>
                    </div>
                </div>
            </div>

            <button onclick="removeItem('${item.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1">
                âœ•
            </button>
        </div>
      `;
      cartItemsContainer.innerHTML += itemHTML;
    });

    cartTotalElement.innerText = total.toFixed(2) + 'â‚¬';
    updateBadgeCount(cart);
  }

  // 3. LOGICA GLOBAL (Para botones inyectados)
  window.updateQuantity = (id, change) => {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const itemIndex = cart.findIndex(i => i.id === id);
    if (itemIndex > -1) {
        cart[itemIndex].quantity += change;
        if (cart[itemIndex].quantity <= 0) {
            cart.splice(itemIndex, 1);
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
        window.dispatchEvent(new Event('cart-updated'));
    }
  };

  window.removeItem = (id) => {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart = cart.filter(i => i.id !== id);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    window.dispatchEvent(new Event('cart-updated'));
  };

  function updateBadgeCount(cart) {
    const badges = document.querySelectorAll('.cart-count-badge');
    const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);
    badges.forEach(badge => {
        badge.innerText = totalItems;
        badge.classList.remove('hidden');
        if(totalItems === 0) badge.classList.add('hidden');
    });
  }

  // 4. CHECKOUT INTELIGENTE
  checkoutBtn.addEventListener('click', () => {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if (cart.length === 0) return;

    // VALIDACIÃ“N DE DATOS
    const name = inputName.value.trim();
    const phone = inputPhone.value.trim();
    const address = inputAddress.value.trim();

    if (!name || !phone || !address) {
        alert('âš ï¸ Por favor, rellena tus DATOS DE ENVÃO antes de finalizar el pedido.');
        inputName.focus();
        return;
    }

    // CONSTRUIR MENSAJE
    let message = `ğŸ‘‹ Hola! Soy *${name}* y quiero hacer este pedido:\n\n`;
    let total = 0;

    cart.forEach(item => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        message += `â–ªï¸ ${item.title}\n   Talla: ${item.size} | Color: ${item.color} | x${item.quantity}\n`;
    });

    message += `\nğŸ’° *TOTAL A PAGAR: ${total.toFixed(2)}â‚¬*`;
    message += `\n----------------------------`;
    message += `\nğŸ“ *DATOS DE ENVÃO:*`;
    message += `\nğŸ‘¤ Nombre: ${name}`;
    message += `\nğŸ“± TelÃ©fono: ${phone}`;
    message += `\nğŸ  DirecciÃ³n: ${address}`;
    message += `\n\nÂ¿CÃ³mo procedemos al pago? Gracias!`;

    // ABRIR WHATSAPP
    const url = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  });

  window.addEventListener('cart-updated', renderCart);
  renderCart();

</script>